name: Setup Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type CREATE'
        required: true

permissions:
  id-token: write   
  contents: read   

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER: EKSDeployment-cluster

jobs:
  checkov-scan:
    if: github.event.inputs.confirm == 'CREATE'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Checkov
        run: |
          pip install checkov
          checkov -d Terraform/ --skip-check CKV_AWS_38,CKV_AWS_39 --compact --quiet --soft-fail

  terraform:
    needs: checkov-scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Apply Terraform
        run: |
          cd Terraform
          terraform init -reconfigure
          terraform apply -auto-approve

  bootstrap-gitops:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: azure/setup-helm@v3
      
      - name: Install Helmfile
        run: |
          wget -qO- https://github.com/helmfile/helmfile/releases/download/v0.169.0/helmfile_0.169.0_linux_amd64.tar.gz | tar xz
          sudo mv helmfile /usr/local/bin/

      - name: Deploy platform components
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}
          
          cd Terraform
          terraform init -reconfigure
          export CERT_MANAGER_ROLE_ARN=$(terraform output -raw cert_manager_role_arn)
          export EXTERNAL_DNS_ROLE_ARN=$(terraform output -raw external_dns_role_arn)
          export CLUSTER_AUTOSCALER_ROLE_ARN=$(terraform output -raw cluster_autoscaler_role_arn)
          export EKS_CLUSTER=${{ env.EKS_CLUSTER }}
          export AWS_REGION=${{ env.AWS_REGION }}
          cd ..
          
          helmfile sync

      - name: Bootstrap GitOps
        run: |
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=600s
          
          kubectl apply -f k8s/bootstrap/cluster-issuer.yaml
          sleep 15
          
          kubectl wait --for=condition=ready certificate -n cert-manager letsencrypt-prod-account-key --timeout=60s || true
          
          kubectl apply -f k8s/bootstrap/argocd-apps.yaml
          sleep 30
          
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-application-controller -n argocd --timeout=300s
          
          sleep 60

      - name: Display status
        run: |
          kubectl get applications -n argocd
          kubectl get certificate -A
          kubectl get ingress -A
          
          echo ""
          echo "ArgoCD Password:"
          kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d
          echo ""
          echo ""
          echo "Grafana Password:"
          kubectl get secret -n monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d
          echo ""