name: Setup Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type CREATE'
        required: true

permissions:
  id-token: write   
  contents: read   

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER: EKSDeployment-cluster

jobs:
  checkov-scan:
    if: github.event.inputs.confirm == 'CREATE'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Checkov IaC Security Scan
        run: |
          echo "Scanning Terraform for security issues..."
          pip install checkov
          checkov -d Terraform/ \
            --skip-check CKV_AWS_38,CKV_AWS_39 \
            --compact --quiet
          echo "Checkov scan completed!"

  terraform:
    needs: checkov-scan
    if: github.event.inputs.confirm == 'CREATE'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Apply Terraform
        run: |
          cd Terraform
          terraform init -reconfigure
          terraform apply -auto-approve

  install-addons:
    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
      - uses: azure/setup-helm@v3
      
      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER }} --region ${{ env.AWS_REGION }}
      
      - name: Install Core Infrastructure
        run: |
          echo "Extracting Terraform outputs..."
          cd Terraform
          terraform init -reconfigure
          CERT_MANAGER_ROLE_ARN=$(terraform output -raw cert_manager_role_arn)
          EXTERNAL_DNS_ROLE_ARN=$(terraform output -raw external_dns_role_arn)
          CLUSTER_AUTOSCALER_ROLE_ARN=$(terraform output -raw cluster_autoscaler_role_arn)
          cd ..

          echo "Adding Helm repositories..."
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add jetstack https://charts.jetstack.io
          helm repo add external-dns https://kubernetes-sigs.github.io/external-dns/
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
          helm repo add autoscaler https://kubernetes.github.io/autoscaler
          helm repo update

          echo "Installing NGINX Ingress Controller..."
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            -n ingress-nginx --create-namespace \
            -f helm-values/nginx-ingress.yaml \
            --wait --timeout 5m

          echo "Installing Cert-Manager..."
          helm upgrade --install cert-manager jetstack/cert-manager \
            -n cert-manager --create-namespace \
            --set crds.enabled=true \
            -f helm-values/cert-manager.yaml \
            --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="${CERT_MANAGER_ROLE_ARN}" \
            --wait --timeout 5m

          echo "Installing ExternalDNS..."
          helm upgrade --install external-dns external-dns/external-dns \
            -n external-dns --create-namespace \
            -f helm-values/external-dns.yaml \
            --set serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="${EXTERNAL_DNS_ROLE_ARN}" \
            --wait --timeout 5m

          echo "Installing Metrics Server..."
          helm upgrade --install metrics-server metrics-server/metrics-server \
            -n kube-system \
            --set args[0]=--kubelet-insecure-tls \
            --wait --timeout 3m

          echo "Installing Cluster Autoscaler..."
          helm upgrade --install cluster-autoscaler autoscaler/cluster-autoscaler \
            -n kube-system \
            --set autoDiscovery.clusterName=${{ env.EKS_CLUSTER }} \
            --set awsRegion=${{ env.AWS_REGION }} \
            --set rbac.serviceAccount.create=true \
            --set rbac.serviceAccount.annotations."eks\.amazonaws\.com/role-arn"="${CLUSTER_AUTOSCALER_ROLE_ARN}" \
            --wait --timeout 3m

      - name: Apply ClusterIssuer
        run: |
          echo "Applying Let's Encrypt ClusterIssuer..."
          kubectl apply -f k8s/cluster-issuer-prod.yaml
          sleep 10
      
      - name: Install Monitoring Stack
        run: |
          echo "Installing Prometheus + Grafana..."
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            -n monitoring --create-namespace \
            --wait --timeout 10m
          
          echo "Monitoring stack installed successfully!"
      
      - name: Install ArgoCD
        run: |
          echo "Installing ArgoCD..."
          kubectl create namespace argocd || true
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
          
          echo "Waiting for ArgoCD to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=5m || true
          
          echo "ArgoCD installed successfully!"
      
      - name: Configure Ingresses
        run: |
          echo "Applying ArgoCD ingress..."
          kubectl apply -f argocd-apps/argocd-ingress.yaml
          
          echo "Applying Grafana ingress..."
          kubectl apply -f k8s/grafana-ingress.yaml
          
          echo "Applying Prometheus ingress..."
          kubectl apply -f k8s/prometheus-ingress.yaml
          
          echo "Waiting for certificate issuance (60 seconds)..."
          sleep 60
      
      - name: Create ArgoCD Application
        run: |
          echo "Creating ArgoCD application for game-2048..."
          kubectl apply -f argocd-apps/game-2048-app.yaml
          
          echo "ArgoCD application created!"
      
      - name: Display Access Information
        run: |
          echo ""
          echo "  INFRASTRUCTURE SETUP COMPLETE! "
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo ""
          echo "CERTIFICATE STATUS:"
          kubectl get certificate -A || echo "Certificates still being issued..."
          echo ""          echo "üåê ACCESS URLs:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo ""
          echo  Game (2048):"
          echo "   https://eks.ahmedmhcodelab.click"
          echo ""
          echo "ArgoCD (GitOps Dashboard):"
          echo "   URL:      https://argocd.ahmedmhcodelab.click"
          echo "   Username: admin"
          echo -n "   Password: "
          kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo "Still starting..."
          echo ""
          echo ""
          echo " Grafana (Monitoring Dashboard):"
          echo "   URL:      https://grafana.ahmedmhcodelab.click"
          echo "   Username: admin"
          echo -n "   Password: "
          kubectl get secret -n monitoring prometheus-grafana -o jsonpath="{.data.admin-password}" 2>/dev/null | base64 -d || echo "Still starting..."
          echo ""
          echo ""
          echo "üîç Prometheus (Metrics):"
          echo "   URL: https://prometheus.ahmedmhcodelab.click"
          echo "   (No authentication required)"
          echo ""
